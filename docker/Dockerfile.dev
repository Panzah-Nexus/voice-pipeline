# Development Dockerfile for fast iteration
FROM mlbra2006/voice-pipeline-airgapped:latest

# Install git and SSH server for development access
RUN apt-get update && apt-get install -y \
    git \
    openssh-server \
    && rm -rf /var/lib/apt/lists/*

# Configure SSH
RUN mkdir /var/run/sshd
RUN echo 'root:runpod' | chpasswd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -i 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' /etc/pam.d/sshd

# Remove the baked-in source code
RUN rm -rf /app/src/

# Create startup script for development
RUN cat > /app/dev_start.sh << 'EOF'
#!/bin/bash
set -e

# Start SSH daemon
service ssh start

echo "ğŸ”§ Development mode starting..."

# Check if we have git credentials
if [ -z "$GIT_TOKEN" ] || [ -z "$GIT_USER" ] || [ -z "$GIT_REPO" ]; then
    echo "âŒ Missing git credentials. Please set:"
    echo "   GIT_USER=your_github_username"
    echo "   GIT_TOKEN=your_personal_access_token"
    echo "   GIT_REPO=your_repo_name (e.g., voice-pipeline)"
    exit 1
fi

# Construct the authenticated git URL
GIT_URL="https://${GIT_USER}:${GIT_TOKEN}@github.com/${GIT_USER}/${GIT_REPO}.git"

# Clone or update source code
if [ ! -d "/app/voice-pipeline-src" ]; then
    echo "ğŸ”„ Cloning latest source code..."
    git clone "$GIT_URL" /app/voice-pipeline-src
else
    echo "ğŸ”„ Updating source code..."
    cd /app/voice-pipeline-src && git pull
fi

# Copy source to working directory
echo "ğŸ“ Copying source code..."
cp -r /app/voice-pipeline-src/src /app/

# Option for volume-mounted source (local development)
if [ -d "/workspace/src" ]; then
    echo "ğŸ“ Using volume-mounted source code..."
    cp -r /workspace/src /app/
fi

echo "ğŸš€ Starting voice pipeline..."
cd /app && python src/main.py
EOF

RUN chmod +x /app/dev_start.sh

# Expose SSH port
EXPOSE 22 8000

# Default command for development
CMD ["/app/dev_start.sh"] 