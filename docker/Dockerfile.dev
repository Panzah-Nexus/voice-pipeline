# Development Dockerfile for fast iteration
FROM mlbra2006/voice-pipeline-airgapped:cascade2

# Install git and SSH server for development access

RUN pip install --upgrade --no-cache-dir onnxruntime-gpu
# Remove the baked-in source code
RUN rm -rf /app/src/

# Create startup script for development
RUN cat > /app/dev_start.sh << 'EOF'
#!/bin/bash
set -e

# Start SSH daemon
service ssh start

echo "ğŸ”§ Development mode starting..."

# Check if we have git credentials
if [ -z "$GIT_TOKEN" ] || [ -z "$GIT_USER" ] || [ -z "$GIT_REPO" ]; then
    echo "âŒ Missing git credentials. Please set:"
    echo "   GIT_USER=your_github_username"
    echo "   GIT_TOKEN=your_personal_access_token"
    echo "   GIT_REPO=your_repo_name (e.g., voice-pipeline)"
    exit 1
fi

# Construct the authenticated git URL
GIT_URL="https://${GIT_USER}:${GIT_TOKEN}@github.com/${GIT_USER}/${GIT_REPO}.git"

# Clone or update source code
if [ ! -d "/app/voice-pipeline-src" ]; then
    echo "ğŸ”„ Cloning latest source code from moonshine branch..."
    git clone -b moonshine "$GIT_URL" /app/voice-pipeline-src
else
    echo "ğŸ”„ Updating source code..."
    cd /app/voice-pipeline-src && git fetch origin moonshine && git reset --hard origin/moonshine
fi

# Copy source to working directory
echo "ğŸ“ Copying source code..."
cp -r /app/voice-pipeline-src/src /app/

# Option for volume-mounted source (local development)
if [ -d "/workspace/src" ]; then
    echo "ğŸ“ Using volume-mounted source code..."
    cp -r /workspace/src /app/
fi

echo "ğŸš€ Starting voice pipeline..."
cd /app && python src/main.py
EOF

RUN chmod +x /app/dev_start.sh

# Expose SSH port
EXPOSE 22 8000 11434

# Default command for development
CMD ["/app/dev_start.sh"] 